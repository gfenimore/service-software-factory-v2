<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Field Configurator with Relations</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            color: #000;
            line-height: 1.5;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: #fff;
            min-height: 100vh;
            border-left: 1px solid #ddd;
            border-right: 1px solid #ddd;
        }

        /* Header */
        .header {
            background: #000;
            color: #fff;
            padding: 16px 24px;
            border-bottom: 2px solid #000;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }

        .header p {
            font-size: 13px;
            opacity: 0.8;
            margin-top: 4px;
        }

        /* Control Bar */
        .control-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: #fff;
            border-bottom: 1px solid #ddd;
        }

        .control-group {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .control-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-item label {
            font-size: 13px;
            font-weight: 500;
        }

        .control-item select {
            padding: 6px 10px;
            border: 1px solid #ccc;
            background: #fff;
            font-size: 13px;
            cursor: pointer;
        }

        .control-item select:focus {
            outline: 2px solid #000;
            outline-offset: 1px;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 6px 14px;
            background: #000;
            color: #fff;
            border: 1px solid #000;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #333;
        }

        .btn.secondary {
            background: #fff;
            color: #000;
        }

        .btn.secondary:hover {
            background: #f5f5f5;
        }

        .btn.danger {
            background: #fff;
            color: #000;
            border-color: #000;
        }

        .btn.danger:hover {
            background: #000;
            color: #fff;
        }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 320px 1fr 450px;
            min-height: calc(100vh - 120px);
        }

        /* Left Panel - Field Selector */
        .field-selector {
            background: #fafafa;
            border-right: 1px solid #ddd;
        }

        .entity-tabs {
            display: flex;
            background: #fff;
            border-bottom: 1px solid #ddd;
        }

        .entity-tab {
            flex: 1;
            padding: 10px 12px;
            background: #fff;
            border: none;
            border-bottom: 2px solid transparent;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .entity-tab:hover {
            background: #fafafa;
        }

        .entity-tab.active {
            border-bottom-color: #000;
            background: #fafafa;
        }

        .entity-tab .badge {
            position: absolute;
            top: 4px;
            right: 4px;
            background: #000;
            color: #fff;
            font-size: 10px;
            padding: 1px 5px;
            border-radius: 10px;
        }

        .entity-tab.active .badge {
            background: #000;
        }

        .fields-list {
            padding: 16px;
            height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .field-group {
            margin-bottom: 20px;
        }

        .field-group-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #666;
            margin-bottom: 8px;
        }

        .field-item {
            background: #fff;
            border: 1px solid #ddd;
            padding: 8px 12px;
            margin-bottom: 4px;
            cursor: move;
            transition: all 0.2s;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .field-item:hover {
            border-color: #000;
            transform: translateX(2px);
        }

        .field-item.dragging {
            opacity: 0.5;
        }

        .field-item.used {
            opacity: 0.4;
            background: #f5f5f5;
        }

        .field-info {
            flex: 1;
        }

        .field-name {
            font-size: 13px;
            font-weight: 500;
        }

        .field-path {
            font-size: 11px;
            color: #666;
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
        }

        .field-type {
            font-size: 10px;
            padding: 2px 6px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            color: #666;
        }

        /* Center Panel - Configuration Builder */
        .config-builder {
            padding: 20px;
            background: #fff;
        }

        .builder-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #ddd;
        }

        .config-row {
            margin-bottom: 16px;
            border: 1px solid #ddd;
            background: #fafafa;
        }

        .config-row.header-row {
            background: #f0f0f0;
            border: 2px solid #000;
        }

        .row-label {
            padding: 8px 12px;
            background: #fff;
            border-bottom: 1px solid #ddd;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .header-row .row-label {
            background: #000;
            color: #fff;
        }

        .row-fields {
            min-height: 60px;
            padding: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .row-fields.drag-over {
            background: #e8e8e8;
            border: 2px dashed #000;
        }

        .config-field {
            background: #fff;
            border: 1px solid #ccc;
            padding: 6px 10px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: move;
            user-select: none;
        }

        .config-field:hover {
            border-color: #000;
        }

        .config-field.dragging {
            opacity: 0.5;
        }

        .config-field .source-tag {
            font-size: 10px;
            font-weight: 600;
            padding: 1px 4px;
            background: #000;
            color: #fff;
        }

        /* Right Panel - Live Preview */
        .live-preview {
            background: #fafafa;
            border-left: 1px solid #ddd;
            padding: 20px;
            min-width: 450px;
        }

        .preview-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #ddd;
        }

        .preview-card {
            background: #fff;
            border: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .preview-header {
            background: #000;
            color: #fff;
            padding: 12px 16px;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-body {
            padding: 16px;
        }

        .preview-row {
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #eee;
        }

        .preview-row:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .preview-row:empty {
            display: none;
        }

        .preview-fields {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .preview-field {
            min-width: 0;
        }

        .preview-label {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            color: #666;
            margin-bottom: 4px;
        }

        .preview-value {
            font-size: 14px;
            color: #000;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Performance Indicator */
        .performance-indicator {
            margin-top: 16px;
            padding: 12px;
            background: #fff;
            border: 1px solid #ddd;
            font-size: 12px;
        }

        .performance-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .performance-label {
            color: #666;
        }

        .performance-value {
            font-weight: 600;
        }

        .performance-value.low { color: #000; }
        .performance-value.medium { color: #666; }
        .performance-value.high { color: #000; text-decoration: underline; }

        /* Empty States */
        .empty-state {
            padding: 40px 20px;
            text-align: center;
            color: #999;
            font-size: 13px;
        }

        .empty-icon {
            font-size: 32px;
            margin-bottom: 8px;
            opacity: 0.3;
        }

        /* Status Message */
        .status-message {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            background: #000;
            color: #fff;
            font-size: 13px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s;
            pointer-events: none;
        }

        .status-message.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Field Configurator with Relations</h1>
            <p>Configure display fields for entities including related data (1:1 relationships only)</p>
        </div>

        <div class="control-bar">
            <div class="control-group">
                <div class="control-item">
                    <label>Entity:</label>
                    <select id="entitySelect">
                        <option value="account">Account</option>
                        <option value="location">Service Location</option>
                        <option value="workorder">Work Order</option>
                    </select>
                </div>
                <div class="control-item">
                    <label>Context:</label>
                    <select id="contextSelect">
                        <option value="list-view">List View Card</option>
                        <option value="detail-header">Detail Header</option>
                        <option value="compact">Compact Card</option>
                        <option value="mobile">Mobile Card</option>
                    </select>
                </div>
            </div>
            <div class="action-buttons">
                <button class="btn" onclick="saveConfiguration()">Save Configuration</button>
                <button class="btn secondary" onclick="exportConfiguration()">Export JSON</button>
                <button class="btn danger" onclick="resetConfiguration()">Reset</button>
            </div>
        </div>

        <div class="main-layout">
            <!-- Left Panel - Field Selector -->
            <div class="field-selector">
                <div class="entity-tabs" id="entityTabs">
                    <!-- Tabs will be populated dynamically -->
                </div>
                <div class="fields-list" id="fieldsList">
                    <!-- Fields will be populated dynamically -->
                </div>
            </div>

            <!-- Center Panel - Configuration Builder -->
            <div class="config-builder">
                <div class="builder-title" id="builderTitle">Configuration: List View Card</div>
                
                <!-- Header Row -->
                <div class="config-row header-row">
                    <div class="row-label">HEADER</div>
                    <div class="row-fields" id="headerFields" data-row="header"></div>
                </div>

                <!-- Body Rows -->
                <div class="config-row">
                    <div class="row-label">ROW 1</div>
                    <div class="row-fields" id="row1Fields" data-row="row1"></div>
                </div>

                <div class="config-row">
                    <div class="row-label">ROW 2</div>
                    <div class="row-fields" id="row2Fields" data-row="row2"></div>
                </div>

                <div class="config-row">
                    <div class="row-label">ROW 3</div>
                    <div class="row-fields" id="row3Fields" data-row="row3"></div>
                </div>
            </div>

            <!-- Right Panel - Live Preview -->
            <div class="live-preview">
                <div class="preview-title">Live Preview</div>
                <div id="previewContainer">
                    <div class="empty-state">
                        <div class="empty-icon">📋</div>
                        <div>Add fields to see preview</div>
                    </div>
                </div>
                <div class="performance-indicator" id="performanceIndicator" style="display: none;">
                    <div class="performance-row">
                        <span class="performance-label">Total Fields:</span>
                        <span class="performance-value" id="totalFields">0</span>
                    </div>
                    <div class="performance-row">
                        <span class="performance-label">Join Count:</span>
                        <span class="performance-value" id="joinCount">0</span>
                    </div>
                    <div class="performance-row">
                        <span class="performance-label">Performance Impact:</span>
                        <span class="performance-value" id="performanceImpact">Low</span>
                    </div>
                    <div class="performance-row">
                        <span class="performance-label">Join Sources:</span>
                        <span class="performance-value" id="joinSources">None</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="status-message" id="statusMessage"></div>

    <script>
        // Data Model
        const entityDefinitions = {
            account: {
                label: 'Account',
                fields: [
                    { name: 'accountNumber', label: 'Account Number', type: 'text', group: 'Core' },
                    { name: 'accountName', label: 'Account Name', type: 'text', group: 'Core' },
                    { name: 'status', label: 'Status', type: 'status', group: 'Core' },
                    { name: 'accountType', label: 'Account Type', type: 'text', group: 'Core' },
                    { name: 'balance', label: 'Balance', type: 'currency', group: 'Financial' },
                    { name: 'creditLimit', label: 'Credit Limit', type: 'currency', group: 'Financial' },
                    { name: 'lastPaymentDate', label: 'Last Payment', type: 'date', group: 'Financial' },
                    { name: 'createdDate', label: 'Created Date', type: 'date', group: 'System' }
                ],
                relationships: [
                    { name: 'primaryContact', label: 'Primary Contact', type: '1:1' },
                    { name: 'billingAddress', label: 'Billing Address', type: '1:1' },
                    { name: 'serviceContract', label: 'Service Contract', type: '1:1' }
                ]
            },
            location: {
                label: 'Service Location',
                fields: [
                    { name: 'locationId', label: 'Location ID', type: 'text', group: 'Core' },
                    { name: 'locationName', label: 'Location Name', type: 'text', group: 'Core' },
                    { name: 'locationType', label: 'Location Type', type: 'text', group: 'Core' },
                    { name: 'status', label: 'Status', type: 'status', group: 'Core' },
                    { name: 'squareFootage', label: 'Square Footage', type: 'number', group: 'Details' },
                    { name: 'occupancy', label: 'Occupancy', type: 'number', group: 'Details' },
                    { name: 'lastServiceDate', label: 'Last Service', type: 'date', group: 'Service' },
                    { name: 'nextServiceDate', label: 'Next Service', type: 'date', group: 'Service' }
                ],
                relationships: [
                    { name: 'siteContact', label: 'Site Contact', type: '1:1' },
                    { name: 'serviceAddress', label: 'Service Address', type: '1:1' },
                    { name: 'accessInfo', label: 'Access Information', type: '1:1' }
                ]
            },
            workorder: {
                label: 'Work Order',
                fields: [
                    { name: 'workOrderNumber', label: 'Work Order #', type: 'text', group: 'Core' },
                    { name: 'description', label: 'Description', type: 'text', group: 'Core' },
                    { name: 'status', label: 'Status', type: 'status', group: 'Core' },
                    { name: 'priority', label: 'Priority', type: 'priority', group: 'Core' },
                    { name: 'scheduledDate', label: 'Scheduled Date', type: 'date', group: 'Schedule' },
                    { name: 'completedDate', label: 'Completed Date', type: 'date', group: 'Schedule' },
                    { name: 'estimatedHours', label: 'Est. Hours', type: 'number', group: 'Details' },
                    { name: 'actualHours', label: 'Actual Hours', type: 'number', group: 'Details' }
                ],
                relationships: [
                    { name: 'assignedTech', label: 'Assigned Technician', type: '1:1' },
                    { name: 'equipment', label: 'Equipment', type: '1:1' }
                ]
            },
            // Related Entity Definitions
            primaryContact: {
                label: 'Primary Contact',
                fields: [
                    { name: 'name', label: 'Contact Name', type: 'text', group: 'Contact' },
                    { name: 'title', label: 'Title', type: 'text', group: 'Contact' },
                    { name: 'email', label: 'Email', type: 'email', group: 'Contact' },
                    { name: 'phone', label: 'Phone', type: 'phone', group: 'Contact' },
                    { name: 'mobile', label: 'Mobile', type: 'phone', group: 'Contact' }
                ]
            },
            billingAddress: {
                label: 'Billing Address',
                fields: [
                    { name: 'street', label: 'Street', type: 'text', group: 'Address' },
                    { name: 'city', label: 'City', type: 'text', group: 'Address' },
                    { name: 'state', label: 'State', type: 'text', group: 'Address' },
                    { name: 'zip', label: 'ZIP Code', type: 'text', group: 'Address' }
                ]
            },
            serviceContract: {
                label: 'Service Contract',
                fields: [
                    { name: 'contractNumber', label: 'Contract #', type: 'text', group: 'Contract' },
                    { name: 'startDate', label: 'Start Date', type: 'date', group: 'Contract' },
                    { name: 'endDate', label: 'End Date', type: 'date', group: 'Contract' }
                ]
            },
            siteContact: {
                label: 'Site Contact',
                fields: [
                    { name: 'name', label: 'Contact Name', type: 'text', group: 'Contact' },
                    { name: 'phone', label: 'Phone', type: 'phone', group: 'Contact' },
                    { name: 'email', label: 'Email', type: 'email', group: 'Contact' }
                ]
            },
            serviceAddress: {
                label: 'Service Address',
                fields: [
                    { name: 'street', label: 'Street', type: 'text', group: 'Address' },
                    { name: 'city', label: 'City', type: 'text', group: 'Address' },
                    { name: 'state', label: 'State', type: 'text', group: 'Address' }
                ]
            },
            accessInfo: {
                label: 'Access Information',
                fields: [
                    { name: 'gateCode', label: 'Gate Code', type: 'text', group: 'Access' },
                    { name: 'specialInstructions', label: 'Instructions', type: 'text', group: 'Access' }
                ]
            },
            assignedTech: {
                label: 'Assigned Technician',
                fields: [
                    { name: 'name', label: 'Tech Name', type: 'text', group: 'Technician' },
                    { name: 'phone', label: 'Phone', type: 'phone', group: 'Technician' },
                    { name: 'certLevel', label: 'Cert Level', type: 'text', group: 'Technician' }
                ]
            },
            equipment: {
                label: 'Equipment',
                fields: [
                    { name: 'model', label: 'Model', type: 'text', group: 'Equipment' },
                    { name: 'serialNumber', label: 'Serial #', type: 'text', group: 'Equipment' }
                ]
            }
        };

        // Sample data for preview
        const sampleData = {
            account: {
                accountNumber: 'ACC-2024-001',
                accountName: 'Acme Corporation',
                status: 'Active',
                accountType: 'Commercial',
                balance: '$12,450.00',
                creditLimit: '$50,000.00',
                lastPaymentDate: '2024-01-15',
                createdDate: '2023-06-01'
            },
            primaryContact: {
                name: 'John Smith',
                title: 'Facility Manager',
                email: 'john.smith@acme.com',
                phone: '(555) 123-4567',
                mobile: '(555) 987-6543'
            },
            billingAddress: {
                street: '123 Business Park Dr',
                city: 'San Francisco',
                state: 'CA',
                zip: '94105'
            },
            serviceContract: {
                contractNumber: 'SVC-2024-001',
                startDate: '2024-01-01',
                endDate: '2024-12-31'
            },
            location: {
                locationId: 'LOC-001',
                locationName: 'Main Office',
                locationType: 'Office Building',
                status: 'Active',
                squareFootage: '25,000',
                occupancy: '85%',
                lastServiceDate: '2024-01-10',
                nextServiceDate: '2024-02-10'
            },
            siteContact: {
                name: 'Jane Doe',
                phone: '(555) 234-5678',
                email: 'jane.doe@site.com'
            },
            serviceAddress: {
                street: '456 Industrial Ave',
                city: 'Oakland',
                state: 'CA'
            },
            accessInfo: {
                gateCode: '1234',
                specialInstructions: 'Use service entrance'
            },
            workorder: {
                workOrderNumber: 'WO-2024-001',
                description: 'Quarterly HVAC Maintenance',
                status: 'Scheduled',
                priority: 'Medium',
                scheduledDate: '2024-02-15',
                completedDate: 'N/A',
                estimatedHours: '4.5',
                actualHours: 'N/A'
            },
            assignedTech: {
                name: 'Mike Johnson',
                phone: '(555) 345-6789',
                certLevel: 'Senior'
            },
            equipment: {
                model: 'HVAC-2000',
                serialNumber: 'SN-123456'
            }
        };

        // Application State
        let currentEntity = 'account';
        let currentContext = 'list-view';
        let currentTab = 'account';
        let configurations = {};
        let currentVersion = '1.0.0';
        let usedFields = new Set();

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadConfigurations();
            initializeControls();
            loadEntityTabs();
            loadFields();
            setupDragAndDrop();
            updatePreview();
        });

        function initializeControls() {
            document.getElementById('entitySelect').addEventListener('change', (e) => {
                currentEntity = e.target.value;
                currentTab = currentEntity;
                loadEntityTabs();
                loadFields();
                loadConfiguration();
                updatePreview();
            });

            document.getElementById('contextSelect').addEventListener('change', (e) => {
                currentContext = e.target.value;
                updateBuilderTitle();
                loadConfiguration();
                updatePreview();
            });
        }

        function loadEntityTabs() {
            const tabsContainer = document.getElementById('entityTabs');
            tabsContainer.innerHTML = '';

            // Primary entity tab
            const primaryDef = entityDefinitions[currentEntity];
            const primaryTab = createTab(currentEntity, primaryDef.label, primaryDef.fields.length, true);
            tabsContainer.appendChild(primaryTab);

            // Related entity tabs
            if (primaryDef.relationships) {
                primaryDef.relationships.forEach(rel => {
                    const relDef = entityDefinitions[rel.name];
                    if (relDef) {
                        const tab = createTab(rel.name, rel.label, relDef.fields.length, false);
                        tabsContainer.appendChild(tab);
                    }
                });
            }
        }

        function createTab(entityName, label, fieldCount, isActive) {
            const tab = document.createElement('button');
            tab.className = `entity-tab ${isActive ? 'active' : ''}`;
            tab.innerHTML = `
                ${label}
                <span class="badge">${fieldCount}</span>
            `;
            tab.onclick = () => switchTab(entityName);
            return tab;
        }

        function switchTab(entityName) {
            currentTab = entityName;
            document.querySelectorAll('.entity-tab').forEach((tab, index) => {
                tab.classList.toggle('active', index === getTabIndex(entityName));
            });
            loadFields();
        }

        function getTabIndex(entityName) {
            const tabs = document.querySelectorAll('.entity-tab');
            for (let i = 0; i < tabs.length; i++) {
                if (tabs[i].textContent.includes(entityDefinitions[entityName]?.label || '')) {
                    return i;
                }
            }
            return 0;
        }

        function loadFields() {
            const container = document.getElementById('fieldsList');
            container.innerHTML = '';

            const entityDef = entityDefinitions[currentTab];
            if (!entityDef) return;

            // Group fields
            const groups = {};
            entityDef.fields.forEach(field => {
                if (!groups[field.group]) groups[field.group] = [];
                groups[field.group].push(field);
            });

            // Render groups
            Object.keys(groups).forEach(groupName => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'field-group';
                
                const title = document.createElement('div');
                title.className = 'field-group-title';
                title.textContent = groupName;
                groupDiv.appendChild(title);

                groups[groupName].forEach(field => {
                    const fieldEl = createFieldElement(field, currentTab);
                    groupDiv.appendChild(fieldEl);
                });

                container.appendChild(groupDiv);
            });
        }

        function createFieldElement(field, source) {
            const div = document.createElement('div');
            const fieldPath = source === currentEntity ? 
                `${source}.${field.name}` : 
                `${source}.${field.name}`;
            
            const isUsed = usedFields.has(fieldPath);
            div.className = `field-item ${isUsed ? 'used' : ''}`;
            div.draggable = !isUsed;
            div.dataset.path = fieldPath;
            div.dataset.source = source;
            div.dataset.type = field.type;
            div.dataset.label = field.label;
            
            div.innerHTML = `
                <div class="field-info">
                    <div class="field-name">${field.label}</div>
                    <div class="field-path">${fieldPath}</div>
                </div>
                <span class="field-type">${field.type}</span>
            `;

            // Double-click to add
            div.addEventListener('dblclick', () => {
                if (!isUsed) {
                    addFieldToNextAvailable(field, source);
                }
            });

            return div;
        }

        function addFieldToNextAvailable(field, source) {
            const rows = ['headerFields', 'row1Fields', 'row2Fields', 'row3Fields'];
            for (const rowId of rows) {
                const row = document.getElementById(rowId);
                if (row.children.length < 4) { // Limit fields per row
                    const fieldPath = `${source}.${field.name}`;
                    addFieldToRow(row, field, source);
                    break;
                }
            }
        }

        function addFieldToRow(row, field, source) {
            const fieldPath = `${source}.${field.name}`;
            if (usedFields.has(fieldPath)) return;

            const fieldEl = document.createElement('div');
            fieldEl.className = 'config-field';
            fieldEl.draggable = true;
            fieldEl.dataset.path = fieldPath;
            fieldEl.dataset.source = source;
            fieldEl.dataset.type = field.type;
            fieldEl.dataset.label = field.label;
            
            const sourceTag = getSourceTag(source);
            fieldEl.innerHTML = `
                <span class="source-tag">${sourceTag}</span>
                ${field.label}
            `;

            // Double-click to remove
            fieldEl.addEventListener('dblclick', () => {
                fieldEl.remove();
                usedFields.delete(fieldPath);
                loadFields(); // Refresh to show field as available
                updatePreview();
            });

            row.appendChild(fieldEl);
            usedFields.add(fieldPath);
            loadFields(); // Refresh to show field as used
            updatePreview();
        }

        function getSourceTag(source) {
            const tags = {
                'account': 'A',
                'location': 'L',
                'workorder': 'WO',
                'primaryContact': 'PC',
                'billingAddress': 'BA',
                'serviceContract': 'SC',
                'siteContact': 'SC',
                'serviceAddress': 'SA',
                'accessInfo': 'AI',
                'assignedTech': 'AT',
                'equipment': 'EQ'
            };
            return tags[source] || source.substring(0, 2).toUpperCase();
        }

        function setupDragAndDrop() {
            // Drag start
            document.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('field-item') && !e.target.classList.contains('used')) {
                    e.target.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'copy';
                    e.dataTransfer.setData('isNew', 'true');
                    e.dataTransfer.setData('path', e.target.dataset.path);
                    e.dataTransfer.setData('source', e.target.dataset.source);
                    e.dataTransfer.setData('type', e.target.dataset.type);
                    e.dataTransfer.setData('label', e.target.dataset.label);
                } else if (e.target.classList.contains('config-field')) {
                    e.target.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('isNew', 'false');
                    e.dataTransfer.setData('path', e.target.dataset.path);
                    e.dataTransfer.setData('source', e.target.dataset.source);
                    e.dataTransfer.setData('type', e.target.dataset.type);
                    e.dataTransfer.setData('label', e.target.dataset.label);
                }
            });

            // Drag end
            document.addEventListener('dragend', (e) => {
                if (e.target.classList.contains('field-item') || e.target.classList.contains('config-field')) {
                    e.target.classList.remove('dragging');
                }
                document.querySelectorAll('.row-fields').forEach(row => {
                    row.classList.remove('drag-over');
                });
            });

            // Setup drop zones
            document.querySelectorAll('.row-fields').forEach(row => {
                row.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    row.classList.add('drag-over');
                });

                row.addEventListener('dragleave', () => {
                    row.classList.remove('drag-over');
                });

                row.addEventListener('drop', (e) => {
                    e.preventDefault();
                    row.classList.remove('drag-over');

                    const isNew = e.dataTransfer.getData('isNew') === 'true';
                    const path = e.dataTransfer.getData('path');
                    const source = e.dataTransfer.getData('source');
                    const type = e.dataTransfer.getData('type');
                    const label = e.dataTransfer.getData('label');

                    if (isNew && !usedFields.has(path)) {
                        const field = { name: path.split('.')[1], label, type };
                        addFieldToRow(row, field, source);
                    } else if (!isNew) {
                        // Move existing field
                        const dragging = document.querySelector('.config-field.dragging');
                        if (dragging && dragging.parentElement !== row) {
                            row.appendChild(dragging);
                            updatePreview();
                        }
                    }
                });
            });
        }

        function updatePreview() {
            const container = document.getElementById('previewContainer');
            const hasFields = document.querySelectorAll('.config-field').length > 0;

            if (!hasFields) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">📋</div>
                        <div>Add fields to see preview</div>
                    </div>
                `;
                document.getElementById('performanceIndicator').style.display = 'none';
                return;
            }

            // Build preview card
            let headerHTML = '';
            const headerFields = Array.from(document.getElementById('headerFields').children);
            if (headerFields.length > 0) {
                headerFields.forEach(field => {
                    const value = getSampleValue(field.dataset.path);
                    headerHTML += ` ${value}`;
                });
            } else {
                headerHTML = entityDefinitions[currentEntity].label;
            }

            let bodyHTML = '';
            ['row1Fields', 'row2Fields', 'row3Fields'].forEach(rowId => {
                const fields = Array.from(document.getElementById(rowId).children);
                if (fields.length > 0) {
                    bodyHTML += '<div class="preview-row"><div class="preview-fields">';
                    fields.forEach(field => {
                        bodyHTML += `
                            <div class="preview-field">
                                <div class="preview-label">${field.dataset.label}</div>
                                <div class="preview-value">${getSampleValue(field.dataset.path)}</div>
                            </div>
                        `;
                    });
                    bodyHTML += '</div></div>';
                }
            });

            container.innerHTML = `
                <div class="preview-card">
                    <div class="preview-header">${headerHTML}</div>
                    <div class="preview-body">${bodyHTML || '<div class="empty-state">No body fields configured</div>'}</div>
                </div>
            `;

            updatePerformanceIndicator();
        }

        function getSampleValue(path) {
            const [source, field] = path.split('.');
            return sampleData[source]?.[field] || 'N/A';
        }

        function updatePerformanceIndicator() {
            const allFields = document.querySelectorAll('.config-field');
            const sources = new Set();
            let totalFields = 0;

            allFields.forEach(field => {
                totalFields++;
                const source = field.dataset.source;
                if (source !== currentEntity) {
                    sources.add(source);
                }
            });

            const joinCount = sources.size;
            const performanceImpact = joinCount <= 1 ? 'low' : joinCount <= 3 ? 'medium' : 'high';

            document.getElementById('performanceIndicator').style.display = 'block';
            document.getElementById('totalFields').textContent = totalFields;
            document.getElementById('joinCount').textContent = joinCount;
            
            const impactEl = document.getElementById('performanceImpact');
            impactEl.textContent = performanceImpact.charAt(0).toUpperCase() + performanceImpact.slice(1);
            impactEl.className = `performance-value ${performanceImpact}`;
            
            document.getElementById('joinSources').textContent = 
                sources.size > 0 ? Array.from(sources).join(', ') : 'None';
        }

        function updateBuilderTitle() {
            const contextLabels = {
                'list-view': 'List View Card',
                'detail-header': 'Detail Header',
                'compact': 'Compact Card',
                'mobile': 'Mobile Card'
            };
            document.getElementById('builderTitle').textContent = 
                `Configuration: ${contextLabels[currentContext]}`;
        }

        function saveConfiguration() {
            const config = buildConfiguration();
            const key = `${currentEntity}_${currentContext}`;
            
            if (!configurations[key]) configurations[key] = [];
            configurations[key].push(config);
            
            localStorage.setItem('fieldConfigurations', JSON.stringify(configurations));
            showStatus('Configuration saved successfully');
        }

        function buildConfiguration() {
            const config = {
                entityType: currentEntity,
                contextType: currentContext,
                header: {
                    rowId: 'header',
                    rowLabel: 'Header',
                    fields: getRowFields('headerFields')
                },
                body: [
                    {
                        rowId: 'row1',
                        rowLabel: 'Row 1',
                        fields: getRowFields('row1Fields')
                    },
                    {
                        rowId: 'row2',
                        rowLabel: 'Row 2',
                        fields: getRowFields('row2Fields')
                    },
                    {
                        rowId: 'row3',
                        rowLabel: 'Row 3',
                        fields: getRowFields('row3Fields')
                    }
                ],
                metadata: {
                    version: incrementVersion(),
                    createdAt: new Date().toISOString(),
                    modifiedAt: new Date().toISOString(),
                    previousVersion: currentVersion,
                    changeNotes: '',
                    joinCount: getJoinCount(),
                    joinSources: getJoinSources(),
                    totalFields: document.querySelectorAll('.config-field').length,
                    performanceImpact: getPerformanceImpact()
                }
            };
            
            return config;
        }

        function getRowFields(rowId) {
            const fields = [];
            const row = document.getElementById(rowId);
            Array.from(row.children).forEach(field => {
                fields.push({
                    path: field.dataset.path,
                    source: field.dataset.source,
                    type: field.dataset.type,
                    label: field.dataset.label
                });
            });
            return fields;
        }

        function getJoinCount() {
            const sources = new Set();
            document.querySelectorAll('.config-field').forEach(field => {
                const source = field.dataset.source;
                if (source !== currentEntity) {
                    sources.add(source);
                }
            });
            return sources.size;
        }

        function getJoinSources() {
            const sources = new Set();
            document.querySelectorAll('.config-field').forEach(field => {
                const source = field.dataset.source;
                if (source !== currentEntity) {
                    sources.add(source);
                }
            });
            return Array.from(sources);
        }

        function getPerformanceImpact() {
            const joinCount = getJoinCount();
            return joinCount <= 1 ? 'low' : joinCount <= 3 ? 'medium' : 'high';
        }

        function incrementVersion() {
            const parts = currentVersion.split('.');
            parts[2] = (parseInt(parts[2]) + 1).toString();
            currentVersion = parts.join('.');
            return currentVersion;
        }

        function loadConfiguration() {
            const key = `${currentEntity}_${currentContext}`;
            const configs = configurations[key];
            
            // Clear current configuration
            resetConfiguration(false);
            
            if (configs && configs.length > 0) {
                const latest = configs[configs.length - 1];
                applyConfiguration(latest);
            }
        }

        function applyConfiguration(config) {
            usedFields.clear();
            
            // Apply header fields
            const headerRow = document.getElementById('headerFields');
            config.header.fields.forEach(field => {
                const fieldEl = createConfigField(field);
                headerRow.appendChild(fieldEl);
                usedFields.add(field.path);
            });
            
            // Apply body fields
            config.body.forEach((row, index) => {
                const rowId = ['row1Fields', 'row2Fields', 'row3Fields'][index];
                const rowEl = document.getElementById(rowId);
                row.fields.forEach(field => {
                    const fieldEl = createConfigField(field);
                    rowEl.appendChild(fieldEl);
                    usedFields.add(field.path);
                });
            });
            
            loadFields(); // Refresh field list
            updatePreview();
        }

        function createConfigField(fieldData) {
            const fieldEl = document.createElement('div');
            fieldEl.className = 'config-field';
            fieldEl.draggable = true;
            fieldEl.dataset.path = fieldData.path;
            fieldEl.dataset.source = fieldData.source;
            fieldEl.dataset.type = fieldData.type;
            fieldEl.dataset.label = fieldData.label;
            
            const sourceTag = getSourceTag(fieldData.source);
            fieldEl.innerHTML = `
                <span class="source-tag">${sourceTag}</span>
                ${fieldData.label}
            `;
            
            fieldEl.addEventListener('dblclick', () => {
                fieldEl.remove();
                usedFields.delete(fieldData.path);
                loadFields();
                updatePreview();
            });
            
            return fieldEl;
        }

        function exportConfiguration() {
            const config = buildConfiguration();
            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `field-config-${currentEntity}-${currentContext}-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showStatus('Configuration exported to JSON');
        }

        function resetConfiguration(confirm = true) {
            if (confirm && !window.confirm('Reset all fields in current configuration?')) {
                return;
            }
            
            ['headerFields', 'row1Fields', 'row2Fields', 'row3Fields'].forEach(rowId => {
                document.getElementById(rowId).innerHTML = '';
            });
            
            usedFields.clear();
            loadFields();
            updatePreview();
            
            if (confirm) {
                showStatus('Configuration reset');
            }
        }

        function loadConfigurations() {
            const saved = localStorage.getItem('fieldConfigurations');
            if (saved) {
                configurations = JSON.parse(saved);
            }
        }

        function showStatus(message) {
            const status = document.getElementById('statusMessage');
            status.textContent = message;
            status.classList.add('show');
            setTimeout(() => {
                status.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>