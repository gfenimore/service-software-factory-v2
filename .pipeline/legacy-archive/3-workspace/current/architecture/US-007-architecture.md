# US-007 Technical Architecture

**Generated by**: ARCHITECT  
**Story**: Work Orders for Selected Service Location  
**Date**: January 16, 2025  
**Value Slice**: 1 - Core Display

---

## 1. Architecture Overview

### 1.1 Component Hierarchy

```
app/accounts/master/page.tsx
└── MasterViewLayout
    └── Column 3: WorkOrdersList/
        ├── WorkOrdersList.tsx (container)
        ├── WorkOrderCard.tsx (display)
        ├── WorkOrderDetailModal.tsx (expansion)
        └── hooks/useWorkOrders.ts (data)
```

### 1.2 Data Flow

```
MasterViewContext (location selection)
    ↓
useWorkOrders hook (fetch by location_id)
    ↓
WorkOrdersList (state management)
    ↓
WorkOrderCard[] (display)
    ↓
WorkOrderDetailModal (on click)
```

---

## 2. Deferred Tasks Registry

### T-001: Database Table Creation (DEFERRED)

**Status**: Deferred until Stage 6/7  
**Workaround**: Use mock data generator  
**Tracking**: Create `.sdlc/12-sdlc-design/sdlc-experimental/10-deferred/US-007-deferred.md`  
**Required Schema**:

```sql
CREATE TABLE work_orders (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  service_location_id UUID REFERENCES service_locations(id),
  work_order_number VARCHAR(50) UNIQUE NOT NULL,
  type VARCHAR(20) CHECK (type IN ('Maintenance', 'Repair', 'Installation', 'Inspection')),
  status VARCHAR(20) CHECK (status IN ('Scheduled', 'Assigned', 'In-Progress', 'Completed', 'Invoiced')),
  priority VARCHAR(10) CHECK (priority IN ('Low', 'Medium', 'High', 'Emergency')),
  scheduled_date DATE NOT NULL,
  scheduled_time_slot VARCHAR(50),
  technician_id UUID,
  technician_name VARCHAR(100),
  description TEXT,
  completion_notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_work_orders_location ON work_orders(service_location_id);
CREATE INDEX idx_work_orders_status ON work_orders(status);
CREATE INDEX idx_work_orders_scheduled ON work_orders(scheduled_date);
```

---

## 3. Type Definitions

### 3.1 Core Types

```typescript
// src/types/workOrder.types.ts

export type WorkOrderType = 'Maintenance' | 'Repair' | 'Installation' | 'Inspection'
export type WorkOrderStatus = 'Scheduled' | 'Assigned' | 'In-Progress' | 'Completed' | 'Invoiced'
export type WorkOrderPriority = 'Low' | 'Medium' | 'High' | 'Emergency'

export interface WorkOrder {
  id: string
  service_location_id: string
  work_order_number: string
  type: WorkOrderType
  status: WorkOrderStatus
  priority: WorkOrderPriority
  scheduled_date: string
  scheduled_time_slot?: string
  technician_id?: string
  technician_name?: string
  description?: string
  completion_notes?: string
  created_at: string
  updated_at: string
}

export interface WorkOrdersListProps {
  locationId: string
  locationName: string
  onWorkOrderSelect?: (workOrderId: string) => void
  className?: string
}

export interface WorkOrderCardProps {
  workOrder: WorkOrder
  onClick?: () => void
  isSelected?: boolean
}

export interface UseWorkOrdersReturn {
  workOrders: WorkOrder[]
  loading: boolean
  error: string | null
  refetch: () => void
}
```

---

## 4. Component Specifications

### 4.1 WorkOrdersList Component

```typescript
// src/components/work-orders/WorkOrdersList.tsx

interface WorkOrdersListState {
  selectedWorkOrderId: string | null
  filterStatus: WorkOrderStatus | 'all'
  searchQuery: string
  isDetailModalOpen: boolean
  selectedWorkOrder: WorkOrder | null
}

// Component responsibilities:
// - Fetch work orders via useWorkOrders hook
// - Manage filter and search state
// - Handle work order selection
// - Render list or empty states
// - Control detail modal visibility
```

### 4.2 WorkOrderCard Component

```typescript
// src/components/work-orders/WorkOrderCard.tsx

// Visual specifications:
// - Card layout matching ServiceLocationCard design
// - Status badge with semantic colors
// - Priority indicator (icon or border)
// - Scheduled date prominently displayed
// - Technician name when assigned
// - Hover state for clickability
```

### 4.3 useWorkOrders Hook

```typescript
// src/hooks/useWorkOrders.ts

// For development (with mock data):
export function useWorkOrders(locationId: string): UseWorkOrdersReturn {
  const [workOrders, setWorkOrders] = useState<WorkOrder[]>([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  useEffect(() => {
    if (!locationId) {
      setWorkOrders([])
      setLoading(false)
      return
    }

    // Mock data for development
    const mockData = generateMockWorkOrders(locationId)
    setWorkOrders(mockData)
    setLoading(false)
  }, [locationId])

  return { workOrders, loading, error, refetch: () => {} }
}

// Production version (to implement in Stage 6):
// - Fetch from Supabase
// - Include technician details via join
// - Handle real-time subscriptions
```

---

## 5. State Management

### 5.1 Local State

- Filter status (WorkOrdersList)
- Search query (WorkOrdersList)
- Selected work order (WorkOrdersList)
- Modal open state (WorkOrdersList)

### 5.2 Context Integration

```typescript
// Read from MasterViewContext
const { selectedLocationId, selectedLocationName } = useMasterView()

// No need to update context for work order selection
// This is local to Column 3
```

---

## 6. Mock Data Generator

```typescript
// src/lib/mock/workOrderMocks.ts

export function generateMockWorkOrders(locationId: string): WorkOrder[] {
  const statuses: WorkOrderStatus[] = [
    'Scheduled',
    'Assigned',
    'In-Progress',
    'Completed',
    'Invoiced',
  ]
  const types: WorkOrderType[] = ['Maintenance', 'Repair', 'Installation', 'Inspection']
  const priorities: WorkOrderPriority[] = ['Low', 'Medium', 'High', 'Emergency']

  return Array.from({ length: 15 }, (_, i) => ({
    id: `wo-${locationId}-${i}`,
    service_location_id: locationId,
    work_order_number: `WO-2025-${String(i + 1).padStart(4, '0')}`,
    type: types[i % types.length],
    status: statuses[i % statuses.length],
    priority: priorities[i % priorities.length],
    scheduled_date: new Date(Date.now() + i * 86400000).toISOString(),
    scheduled_time_slot: i % 2 === 0 ? 'Morning (8AM-12PM)' : 'Afternoon (12PM-5PM)',
    technician_id: i % 3 === 0 ? undefined : `tech-${i}`,
    technician_name: i % 3 === 0 ? undefined : `Technician ${i}`,
    description: `${types[i % types.length]} work for location`,
    completion_notes:
      statuses[i % statuses.length] === 'Completed' ? 'Work completed successfully' : undefined,
    created_at: new Date(Date.now() - i * 86400000).toISOString(),
    updated_at: new Date().toISOString(),
  }))
}
```

---

## 7. Styling Specifications

### 7.1 Status Colors

```typescript
export const statusColors = {
  Scheduled: 'bg-gray-100 text-gray-700',
  Assigned: 'bg-blue-100 text-blue-700',
  'In-Progress': 'bg-yellow-100 text-yellow-700',
  Completed: 'bg-green-100 text-green-700',
  Invoiced: 'bg-purple-100 text-purple-700',
}
```

### 7.2 Priority Indicators

```typescript
export const priorityStyles = {
  Emergency: 'border-l-4 border-red-500',
  High: 'border-l-4 border-orange-500',
  Medium: 'border-l-4 border-blue-500',
  Low: 'border-l-4 border-gray-300',
}
```

---

## 8. Integration Points

### 8.1 With Master View

```typescript
// In app/accounts/master/page.tsx, Column 3:
<WorkOrdersList
  locationId={selectedLocationId || ''}
  locationName={selectedLocation?.name || ''}
  onWorkOrderSelect={(workOrderId) => {
    console.log('Work order selected:', workOrderId);
    // Future: Could update context or trigger actions
  }}
  className="h-full"
/>
```

### 8.2 Import Requirements

```typescript
// Components to import
import { WorkOrdersList } from '@/components/work-orders/WorkOrdersList'

// Types to import
import type { WorkOrder } from '@/types/workOrder.types'

// Hooks to import
import { useWorkOrders } from '@/hooks/useWorkOrders'
```

---

## 9. Performance Considerations

### 9.1 Initial Implementation

- Static pagination (20 items)
- Simple filtering (client-side)
- Basic search (client-side)

### 9.2 Future Optimizations

- Virtual scrolling for 50+ items
- Server-side filtering
- Debounced search
- Real-time updates via subscriptions

---

## 10. Testing Strategy

### 10.1 Component Tests

```typescript
// WorkOrderCard.test.tsx
describe('WorkOrderCard', () => {
  it('displays all work order fields')
  it('applies correct status color')
  it('shows priority indicator')
  it('handles click events')
})

// WorkOrdersList.test.tsx
describe('WorkOrdersList', () => {
  it('fetches work orders for location')
  it('filters by status')
  it('searches by ID and description')
  it('opens detail modal on card click')
})
```

### 10.2 Mock Data Tests

```typescript
describe('Mock Data Generator', () => {
  it('generates correct number of work orders')
  it('includes all required fields')
  it('varies statuses and priorities')
})
```

---

## 11. File Structure

```
src/
├── components/
│   └── work-orders/
│       ├── WorkOrdersList.tsx
│       ├── WorkOrderCard.tsx
│       └── WorkOrderDetailModal.tsx
├── hooks/
│   └── useWorkOrders.ts
├── types/
│   └── workOrder.types.ts
└── lib/
    └── mock/
        └── workOrderMocks.ts
```

---

## 12. Processor Sequence

Based on this architecture, the recommended processor sequence is:

1. **TYPE-PROCESSOR** → Create workOrder.types.ts
2. **MOCK-PROCESSOR** → Create workOrderMocks.ts
3. **HOOK-PROCESSOR** → Create useWorkOrders.ts
4. **SCAFFOLD-PROCESSOR** → Create component shells
5. **REACT-PROCESSOR** → Add React logic
6. **INTEGRATION-PROCESSOR** → Wire into master view

---

**Architecture Ready for Processor Selection**
